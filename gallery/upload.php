<?php    require_once $_SERVER['DOCUMENT_ROOT']."/gallery/function.php";    if (is_dir('upload')){       $uploadPath = $_SERVER['DOCUMENT_ROOT'].'/gallery/upload/';    }else {        mkdir('upload');    }$files = [];// Преобразуем массив $_FILES в удобный вид для перебора в foreach.    if (!empty($_FILES['upload'])){        $diff = count($_FILES['upload']) - count($_FILES['upload'], COUNT_RECURSIVE);        if ($diff == 0) {            $files = [$_FILES['upload']];        } else {            foreach($_FILES['upload'] as $k => $l) {                foreach($l as $i => $v) {                    $files[$i][$k] = $v;                }            }        }    }// Загружаем все картинки по порядкуforeach ($files as $file) {        // Загружаем по одному файлу        $filePath  =  $file['tmp_name'];        $fileName  =  $file['name'];        $errorCode =  $file['error'];// Валидация файла проверка на ошибки при загрузке    outputMessage($filePath);// Создадим ресурс FileInfo    $fi = finfo_open(FILEINFO_MIME_TYPE);// Получим MIME-тип    if(empty($_FILES['name'])){        $mime = (string) finfo_file($fi, $filePath);    }// Закроем ресурс    finfo_close($fi);// Проверим ключевое слово image (image/jpeg, image/png и т. д.)    if (strpos($mime, 'image') === false)        die('Можно загружать только изображения.'.' <a href="index.php">Вернуться обратно </a>');// Результат функции запишем в переменную    $image = getimagesize($filePath);// Сгенерируем расширение файла на основе типа картинки    $extension = image_type_to_extension($image[2]);// Сократим .jpeg до .jpg    $format = str_replace('jpeg', 'jpg', $extension);// Чтобы не затереть файл с таким же названием, добавим префикс.    $parts = $filename = pathinfo($fileName, PATHINFO_FILENAME); //  Название файла на основе его изначального названия    //$parts = md5_file($filePath); //  Название файла на основе MD5-хеша    //$parts = date("Y-m-d_H-i-s");; //  Название файла на основе даты загрузки    $i = 0;    $prefix = '';    while (is_file($uploadPath . $parts . $prefix . $format)) {        $prefix = '(' . ++$i . ')';    }    $name = $parts . $prefix;    // Переместим картинку с новым именем и расширением в папку /upload    if(empty($_FILES['name'])){        if (count($_FILES['upload']['name']) < 5){                if (!move_uploaded_file($file['tmp_name'], $uploadPath . $name . $format)) {                    die('При записи изображения на диск произошла ошибка.');                }else{                        if (!isset($outputMessage)){                           header('Location: gallery.php');                        }                    }        }else{            echo 'Колличество файлов привышено!';        }    }else{        echo 'Ошибка загрузки';    }}